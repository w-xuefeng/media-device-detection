const e=Symbol.for("@ts-pattern/matcher"),t=Symbol.for("@ts-pattern/isVariadic"),n="@ts-pattern/anonymous-select-key",i=e=>Boolean(e&&"object"==typeof e),o=t=>t&&!!t[e],r=(n,a,s)=>{if(o(n)){const t=n[e](),{matched:i,selections:o}=t.match(a);return i&&o&&Object.keys(o).forEach((e=>s(e,o[e]))),i}if(i(n)){if(!i(a))return!1;if(Array.isArray(n)){if(!Array.isArray(a))return!1;let e=[],i=[],c=[];for(const r of n.keys()){const a=n[r];o(a)&&a[t]?c.push(a):c.length?i.push(a):e.push(a)}if(c.length){if(c.length>1)throw new Error("Pattern error: Using `...P.array(...)` several times in a single pattern is not allowed.");if(a.length<e.length+i.length)return!1;const t=a.slice(0,e.length),n=0===i.length?[]:a.slice(-i.length),o=a.slice(e.length,0===i.length?1/0:-i.length);return e.every(((e,n)=>r(e,t[n],s)))&&i.every(((e,t)=>r(e,n[t],s)))&&(0===c.length||r(c[0],o,s))}return n.length===a.length&&n.every(((e,t)=>r(e,a[t],s)))}return Reflect.ownKeys(n).every((t=>{const i=n[t];return(t in a||o(c=i)&&"optional"===c[e]().matcherType)&&r(i,a[t],s);var c}))}return Object.is(a,n)},a=t=>{var n,r,c;return i(t)?o(t)?null!=(n=null==(r=(c=t[e]()).getSelectionKeys)?void 0:r.call(c))?n:[]:Array.isArray(t)?s(t,a):s(Object.values(t),a):[]},s=(e,t)=>e.reduce(((e,n)=>e.concat(t(n))),[]);function c(t){return Object.assign(t,{optional:()=>{return n=t,c({[e]:()=>({match:e=>{let t={};const i=(e,n)=>{t[e]=n};return void 0===e?(a(n).forEach((e=>i(e,void 0))),{matched:!0,selections:t}):{matched:r(n,e,i),selections:t}},getSelectionKeys:()=>a(n),matcherType:"optional"})});var n},and:e=>u(t,e),or:n=>function(...t){return c({[e]:()=>({match:e=>{let n={};const i=(e,t)=>{n[e]=t};return s(t,a).forEach((e=>i(e,void 0))),{matched:t.some((t=>r(t,e,i))),selections:n}},getSelectionKeys:()=>s(t,a),matcherType:"or"})})}(t,n),select:e=>void 0===e?d(t):d(e,t)})}function u(...t){return c({[e]:()=>({match:e=>{let n={};const i=(e,t)=>{n[e]=t};return{matched:t.every((t=>r(t,e,i))),selections:n}},getSelectionKeys:()=>s(t,a),matcherType:"and"})})}function l(t){return{[e]:()=>({match:e=>({matched:Boolean(t(e))})})}}function d(...t){const i="string"==typeof t[0]?t[0]:void 0,o=2===t.length?t[1]:"string"==typeof t[0]?void 0:t[0];return c({[e]:()=>({match:e=>{let t={[null!=i?i:n]:e};return{matched:void 0===o||r(o,e,((e,n)=>{t[e]=n})),selections:t}},getSelectionKeys:()=>[null!=i?i:n].concat(void 0===o?[]:a(o))})})}function h(e){return"number"==typeof e}function p(e){return"string"==typeof e}function m(e){return"bigint"==typeof e}c(l((function(e){return!0})));const f=e=>Object.assign(c(e),{startsWith:t=>{return f(u(e,(n=t,l((e=>p(e)&&e.startsWith(n))))));var n},endsWith:t=>{return f(u(e,(n=t,l((e=>p(e)&&e.endsWith(n))))));var n},minLength:t=>{return f(u(e,(n=t,l((e=>p(e)&&e.length>=n)))));var n},length:t=>{return f(u(e,(n=t,l((e=>p(e)&&e.length===n)))));var n},maxLength:t=>{return f(u(e,(n=t,l((e=>p(e)&&e.length<=n)))));var n},includes:t=>{return f(u(e,(n=t,l((e=>p(e)&&e.includes(n))))));var n},regex:t=>{return f(u(e,(n=t,l((e=>p(e)&&Boolean(e.match(n)))))));var n}}),g=(f(l(p)),e=>Object.assign(c(e),{between:(t,n)=>{return g(u(e,(i=t,o=n,l((e=>h(e)&&i<=e&&o>=e)))));var i,o},lt:t=>{return g(u(e,(n=t,l((e=>h(e)&&e<n)))));var n},gt:t=>{return g(u(e,(n=t,l((e=>h(e)&&e>n)))));var n},lte:t=>{return g(u(e,(n=t,l((e=>h(e)&&e<=n)))));var n},gte:t=>{return g(u(e,(n=t,l((e=>h(e)&&e>=n)))));var n},int:()=>g(u(e,l((e=>h(e)&&Number.isInteger(e))))),finite:()=>g(u(e,l((e=>h(e)&&Number.isFinite(e))))),positive:()=>g(u(e,l((e=>h(e)&&e>0)))),negative:()=>g(u(e,l((e=>h(e)&&e<0))))})),v=(g(l(h)),e=>Object.assign(c(e),{between:(t,n)=>{return v(u(e,(i=t,o=n,l((e=>m(e)&&i<=e&&o>=e)))));var i,o},lt:t=>{return v(u(e,(n=t,l((e=>m(e)&&e<n)))));var n},gt:t=>{return v(u(e,(n=t,l((e=>m(e)&&e>n)))));var n},lte:t=>{return v(u(e,(n=t,l((e=>m(e)&&e<=n)))));var n},gte:t=>{return v(u(e,(n=t,l((e=>m(e)&&e>=n)))));var n},positive:()=>v(u(e,l((e=>m(e)&&e>0)))),negative:()=>v(u(e,l((e=>m(e)&&e<0))))}));v(l(m)),c(l((function(e){return"boolean"==typeof e}))),c(l((function(e){return"symbol"==typeof e}))),c(l((function(e){return null==e}))),c(l((function(e){return null!=e})));var b=class extends Error{constructor(e){let t;try{t=JSON.stringify(e)}catch(n){t=e}super(`Pattern matching error: no pattern matches value ${t}`),this.input=void 0,this.input=e}};const x={matched:!1,value:void 0};var y=class e{constructor(e,t){this.input=void 0,this.state=void 0,this.input=e,this.state=t}with(...t){if(this.state.matched)return this;const i=t[t.length-1],o=[t[0]];let a;3===t.length&&"function"==typeof t[1]?a=t[1]:t.length>2&&o.push(...t.slice(1,t.length-1));let s=!1,c={};const u=(e,t)=>{s=!0,c[e]=t},l=!o.some((e=>r(e,this.input,u)))||a&&!Boolean(a(this.input))?x:{matched:!0,value:i(s?n in c?c[n]:c:this.input,this.input)};return new e(this.input,l)}when(t,n){if(this.state.matched)return this;const i=Boolean(t(this.input));return new e(this.input,i?{matched:!0,value:n(this.input,this.input)}:x)}otherwise(e){return this.state.matched?this.state.value:e(this.input)}exhaustive(e=w){return this.state.matched?this.state.value:e(this.input)}run(){return this.exhaustive()}returnType(){return this}};function w(e){throw new b(e)}function C(e,t,n={}){let i,o=0;return(...r)=>{const a=Date.now();o||!1!==n.leading||(o=a);const s=t-(a-o);s<0?(i&&(clearTimeout(i),i=null),o=a,e(...r)):i||!1===n.trailing||(i=window.setTimeout((()=>{o=!1===n.leading?0:(new Date).getTime(),i=null,e(...r)}),s))}}function D(e,t){const n=Array.isArray(t)?t:[t],i="string"==typeof e?document.querySelector(e):e;i&&n.forEach((e=>{i?.classList?.contains?.(e)||i?.classList?.add?.(e)}))}function E(e,t,n=document.documentElement,i){return n||console.log(`[setCssVar ${e}: ${t} error] dom may not exist`,n),(Array.isArray(n)?n:[n]).forEach((n=>{"string"==typeof n?document.querySelector(n)?.style.setProperty(e,t,i):n?.style.setProperty(e,t,i)}))}function O(e,t,n){const i=document.createElement(e);return t&&Object.entries(t).forEach((([e,t])=>{"arrts"===e&&"object"==typeof t&&null!==t?Object.entries(t).forEach((([e,t])=>{i.setAttribute(e,t)})):"on"===e&&"object"==typeof t&&null!==t?Object.entries(t).forEach((([e,t])=>{i.addEventListener(e,"function"==typeof t?t.bind(i):{...t,handleEvent:t.handleEvent.bind(i)})})):"style"===e?"object"==typeof t&&null!==t?Object.entries(t).forEach((([e,t])=>{Reflect.set(i.style,e,t)})):"string"==typeof t&&Reflect.set(i.style,"cssText",t):"arrts"!==e&&"on"!==e&&"style"!==e&&Reflect.set(i,e,t)})),n&&i.append.apply(i,Array.isArray(n)?n:[n]),i}function L(e,t){const n=t(),i=Array.isArray(n)?n:[n];return Array.from(e.childNodes).forEach((t=>e.removeChild(t))),e.append.apply(e,i),e}const A=(e="")=>`volume-detection-processor${e}`,R=e=>function(e){const t=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(t)}((e=>`registerProcessor('${A(e)}',class VolumeDetectionProcessor extends AudioWorkletProcessor{constructor(){super()}process(inputs){const input=inputs[0][0];let buffer=new Float32Array(input);const maxVal=Math.max(...buffer);buffer = null;this.port.postMessage({type:'volumeChange',volume:maxVal*100});return true}});`)(e));var I={volumeChangeEventName:`media-device-detection-volume-change-${Date.now()}`,defaultCameraList:[{label:"4K(UHD)",width:3840,height:2160,ratio:"16:9"},{label:"4K(UHD)",width:2160,height:3840,ratio:"9:16"},{label:"2K",width:2560,height:1440,ratio:"16:9"},{label:"2K",width:1440,height:2560,ratio:"9:16"},{label:"1080p(FHD)",width:1920,height:1080,ratio:"16:9"},{label:"1080p(FHD)",width:1080,height:1920,ratio:"9:16"},{label:"UXGA",width:1600,height:1200,ratio:"4:3"},{label:"UXGA",width:1200,height:1600,ratio:"3:4"},{label:"720p(HD)",width:1280,height:720,ratio:"16:9"},{label:"720p(HD)",width:720,height:1280,ratio:"9:16"},{label:"SVGA",width:800,height:600,ratio:"4:3"},{label:"SVGA",width:600,height:800,ratio:"3:4"},{label:"VGA",width:640,height:480,ratio:"4:3"},{label:"360p(nHD)",width:640,height:360,ratio:"16:9"},{label:"CIF",width:352,height:288,ratio:"4:3"},{label:"QVGA",width:320,height:240,ratio:"4:3"},{label:"QCIF",width:176,height:144,ratio:"4:3"},{label:"QQVGA",width:160,height:120,ratio:"4:3"}]},k=class{audioContext=null;audioWorkletNode=null;micStream=null;micStreamSource=null;onGetCameraError=e=>{console.debug("getCameraDeviceList error",e)};onGetMicrophoneError=e=>{console.debug("getMicrophoneDeviceList error",e)};onGetAudioOutputError=e=>{console.debug("getAudioOutputDeviceList error",e)};constructor(e){"function"==typeof e?.onGetCameraError&&(this.onGetCameraError=e.onGetCameraError),"function"==typeof e?.onGetMicrophoneError&&(this.onGetMicrophoneError=e.onGetMicrophoneError),"function"==typeof e?.onGetAudioOutputError&&(this.onGetAudioOutputError=e.onGetAudioOutputError)}watchPermissions(e){const t=new AbortController;return(async()=>{const n=await navigator.permissions.query({name:"microphone"}),i=await navigator.permissions.query({name:"camera"});n.addEventListener("change",(t=>{const n=t.target;e("microphone",n.state,t)}),{signal:t.signal}),i.addEventListener("change",(t=>{const n=t.target;e("camera",n.state,t)}),{signal:t.signal})})(),t}async getCameraList(){try{const e=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)),t=async e=>{try{const t=await navigator.mediaDevices.getUserMedia({video:{deviceId:e.deviceId}}),n=t.getTracks().find((e=>"video"===e.kind));if(!n)return null;const i=Object.assign({},{InputDeviceInfo:e},n.getCapabilities());return t.getTracks().forEach((e=>e.stop())),i}catch(e){return this.onGetCameraError(e),null}},n=e.map(t),i=await Promise.allSettled(n),o=i.filter((e=>"fulfilled"===e.status&&e.value)).map((e=>e.value));return o.sort(((e,t)=>(e.width?.max||0)-(t.width?.max||0)))}catch(e){this.onGetCameraError(e)}}getResolution(e){return I.defaultCameraList.filter((t=>t.width<=(e.width?.max||0)&&t.height<=(e.height?.max||0)))}async getMicrophoneList(){try{return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"audioinput"===e.kind))}catch(e){this.onGetMicrophoneError(e)}}async getAudioOutputDeviceList(){try{return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"audiooutput"===e.kind))}catch(e){this.onGetAudioOutputError(e)}}async testMicrophone(e){try{if(this.audioContext)this.closeCurrentMicrophone();else{this.audioContext=new(globalThis.AudioContext||globalThis.webkitAudioContext);const t=`-${e}`;await this.audioContext.audioWorklet.addModule(R(t)),this.audioWorkletNode=new AudioWorkletNode(this.audioContext,A(t)),this.audioWorkletNode.port.onmessage=e=>{if("volumeChange"===e.data.type){const t=e.data.volume;globalThis.dispatchEvent(new CustomEvent(I.volumeChangeEventName,{detail:t}))}},this.audioWorkletNode.connect(this.audioContext.destination)}const t=await navigator.mediaDevices.getUserMedia({audio:{deviceId:e,echoCancellation:!0}});this.micStream=t,this.micStreamSource=this.audioContext.createMediaStreamSource(this.micStream),this.audioWorkletNode&&this.micStreamSource.connect(this.audioWorkletNode)}catch(e){this.onGetMicrophoneError(e)}}closeCurrentMicrophone(){this.audioWorkletNode&&this.micStreamSource?.disconnect(this.audioWorkletNode),this.micStream?.getAudioTracks().forEach((e=>{e.stop()}))}releaseMicrophone(){this.closeCurrentMicrophone(),this.audioWorkletNode?.disconnect(),this.audioContext=null}};const M="media-device-detection-",S=`${M}dialog`,N=`${M}panel`,P=".media-device-detection-dialog {\n  --action-bar-height: 38px;\n  --width: clamp(500px, 80vw, 1000px);\n  --height: clamp(300px, 60vh, 500px);\n\n  display: flex;\n  flex-direction: column;\n  width: var(--width);\n  height: var(--height);\n  border-color: transparent;\n\n  .acton-bar {\n    height: var(--action-bar-height);\n    display: flex;\n    align-items: center;\n    justify-content: flex-end;\n    gap: 12px;\n\n    .cancel-btn {\n      box-sizing: border-box;\n      padding: 5px 20px;\n      font-size: 14px;\n      color: #1e90ff;\n      border-radius: 2px;\n      cursor: pointer;\n      outline: none;\n      border: 1px solid #1e90ff;\n      background-color: #fff;\n    }\n\n    .confirm-btn {\n      box-sizing: border-box;\n      padding: 5px 20px;\n      font-size: 14px;\n      color: #fff;\n      border-radius: 2px;\n      cursor: pointer;\n      outline: none;\n      border: none;\n      background: #1e90ff;\n    }\n  }\n\n  .permission {\n    display: none;\n  }\n\n  .permission:has(div) {\n    display: flex;\n    flex-direction: column;\n    position: fixed;\n    top: 30px;\n    left: 50%;\n    transform: translateX(-50%);\n    color: #ffffff;\n    background: #ff0000;\n    padding: 10px 20px;\n    border: 1px solid #f40;\n    border-radius: 4px;\n    justify-content: center;\n    align-items: center;\n    line-height: 20px;\n    font-size: 16px;\n    .no-permission {\n      margin-top: 4px;\n    }\n  }\n\n  .main {\n    display: flex;\n    justify-content: center;\n    gap: 10%;\n    flex-grow: 1;\n\n    .camera {\n      flex: 1;\n    }\n\n    .label {\n      margin: 0 0 10px 0;\n      color: #999;\n      font-weight: 400;\n    }\n\n    .media-select {\n      width: 100%;\n      padding: 8px 0;\n      border: 1px solid #eee;\n      color: #666;\n      cursor: pointer;\n      outline: none;\n    }\n    .camera-video {\n      border: 1px solid #eaeaea;\n      margin-top: 20px;\n      width: 100%;\n      border-radius: 4px;\n      min-height: 270px;\n      background-color: #eaeaea;\n    }\n\n    .audio-output-visualization-container {\n      width: 100%;\n      min-height: 160px;\n      margin-block-start: 12px;\n      outline: 1px solid #eee;\n      background-color: #1d1d1d;\n      display: flex;\n      flex-direction: column;\n      justify-content: flex-end;\n    }\n\n    .microphone-sound {\n      flex: 1;\n\n      .sound-play {\n        width: 100%;\n        height: 40px;\n        display: flex;\n        align-items: center;\n        border-radius: 2px;\n        border: 1px solid #dcdfe6;\n        margin-top: 20px;\n        padding: 0px 8px;\n        box-sizing: border-box;\n        cursor: pointer;\n\n        .sound-play-right {\n          margin-left: auto;\n        }\n      }\n\n      .microphone-detection {\n        width: 100%;\n        height: 10px;\n        margin-top: 10px;\n        border-radius: 2px;\n        overflow: hidden;\n        background-color: #eaeaea;\n        position: relative;\n\n        .line-gap {\n          height: 100%;\n          width: 2px;\n          background-color: #ffffff;\n          position: absolute;\n          top: 0;\n        }\n\n        .microphone-voice {\n          --volume-width: 0;\n          width: var(--volume-width);\n          height: 100%;\n          background-color: #2980fb;\n        }\n      }\n    }\n  }\n\n  .disabled {\n    background-color: #f5f7fa;\n    color: #b1b4ba;\n    cursor: not-allowed !important;\n  }\n}\n",j=".media-device-detection-panel {\n  --action-bar-height: 38px;\n  --width: clamp(500px, 80vw, 1000px);\n  --height: clamp(300px, 60vh, 500px);\n\n  display: flex;\n  flex-direction: column;\n  width: var(--width);\n  height: var(--height);\n  border-color: transparent;\n\n  .acton-bar {\n    height: var(--action-bar-height);\n    display: flex;\n    align-items: center;\n    justify-content: flex-end;\n    gap: 12px;\n\n    .cancel-btn {\n      box-sizing: border-box;\n      padding: 5px 20px;\n      font-size: 14px;\n      color: #1e90ff;\n      border-radius: 2px;\n      cursor: pointer;\n      outline: none;\n      border: 1px solid #1e90ff;\n      background-color: #fff;\n    }\n\n    .confirm-btn {\n      box-sizing: border-box;\n      padding: 5px 20px;\n      font-size: 14px;\n      color: #fff;\n      border-radius: 2px;\n      cursor: pointer;\n      outline: none;\n      border: none;\n      background: #1e90ff;\n    }\n  }\n\n  .permission {\n    display: none;\n  }\n\n  .permission:has(div) {\n    display: flex;\n    flex-direction: column;\n    position: fixed;\n    top: 30px;\n    left: 50%;\n    transform: translateX(-50%);\n    color: #ffffff;\n    background: #ff0000;\n    padding: 10px 20px;\n    border: 1px solid #f40;\n    border-radius: 4px;\n    justify-content: center;\n    align-items: center;\n    line-height: 20px;\n    font-size: 16px;\n    .no-permission {\n      margin-top: 4px;\n    }\n  }\n\n  .main {\n    display: flex;\n    justify-content: center;\n    gap: 10%;\n    flex-grow: 1;\n\n    .camera {\n      flex: 1;\n    }\n\n    .label {\n      margin: 0 0 10px 0;\n      color: #999;\n      font-weight: 400;\n    }\n\n    .media-select {\n      width: 100%;\n      padding: 8px 0;\n      border: 1px solid #eee;\n      color: #666;\n      cursor: pointer;\n      outline: none;\n    }\n    .camera-video {\n      border: 1px solid #eaeaea;\n      margin-top: 20px;\n      width: 100%;\n      border-radius: 4px;\n      min-height: 270px;\n      background-color: #eaeaea;\n    }\n\n    .audio-output-visualization-container {\n      width: 100%;\n      min-height: 160px;\n      margin-block-start: 12px;\n      outline: 1px solid #eee;\n      background-color: #1d1d1d;\n      display: flex;\n      flex-direction: column;\n      justify-content: flex-end;\n    }\n\n    .microphone-sound {\n      flex: 1;\n\n      .sound-play {\n        width: 100%;\n        height: 40px;\n        display: flex;\n        align-items: center;\n        border-radius: 2px;\n        border: 1px solid #dcdfe6;\n        margin-top: 20px;\n        padding: 0px 8px;\n        box-sizing: border-box;\n        cursor: pointer;\n\n        .sound-play-right {\n          margin-left: auto;\n        }\n      }\n\n      .microphone-detection {\n        width: 100%;\n        height: 10px;\n        margin-top: 10px;\n        border-radius: 2px;\n        overflow: hidden;\n        background-color: #eaeaea;\n        position: relative;\n\n        .line-gap {\n          height: 100%;\n          width: 2px;\n          background-color: #ffffff;\n          position: absolute;\n          top: 0;\n        }\n\n        .microphone-voice {\n          --volume-width: 0;\n          width: var(--volume-width);\n          height: 100%;\n          background-color: #2980fb;\n        }\n      }\n    }\n  }\n\n  .disabled {\n    background-color: #f5f7fa;\n    color: #b1b4ba;\n    cursor: not-allowed !important;\n  }\n}\n",{value:G,onChange:T,clean:V,internalParentKey:$}=function(e,t={deep:!1}){let n=[];const i="__parentKey";function o(e,t,i=!1){const o="number"==typeof e?String(e):e;if(t.watchProperties?t.watchProperties.push(o):t.watchProperties=[o],!n.includes(t)){if(i){const e=(i,o,r,a)=>{t(i,o,r,a),n=n.filter((t=>t!==e))};return e.watchProperties=[o],void n.push(e)}n.push(t)}}function r(e,t,n=!1){e.forEach((e=>{o(e,t,n)}))}function a(e,t,n,o,r,a){n!==i&&(e.watchProperties?e.watchProperties?.includes(n)&&e(r,a,o,n):e(o,n,r,a))}const s={get(e,n){const o=Reflect.get(e,n),r=!!t.excludeType&&t.excludeType.some((e=>o instanceof e));if(!t?.deep||"object"!=typeof o||null===o||r)return o;const a=new Proxy(o,s),c=Reflect.get(e,i)||"";console.debug("[[GET Object]]",e,c,o);const u=[c,n].filter(Boolean).join(".");return Reflect.set(a,i,u),a},set(e,t,o){const r=Reflect.get(e,t);if(r===o)return!0;const s=[Reflect.get(e,i)||"",t].filter(Boolean).join(".");return console.debug("[[SET Object]]",e,s,o),Reflect.set(e,t,o),n.forEach((n=>a(n,0,t,e,o,r))),!0},deleteProperty(e,t){const o=Reflect.get(e,t),r=Reflect.deleteProperty(e,t);[Reflect.get(e,i)||"",t].filter(Boolean).join(".");return n.forEach((n=>a(n,0,t,e,void 0,o))),r},defineProperty(e,t,o){const r=Reflect.get(e,t),s=Reflect.defineProperty(e,t,o);[Reflect.get(e,i)||"",t].filter(Boolean).join(".");return n.forEach((n=>a(n,0,t,e,o?.value||o?.get?.(),r))),s}};return{value:new Proxy(e,s),on:function(e,t=!1){if(!n.includes(e))if(t){const t=(i,o,r,a)=>{e(i,o,r,a),n=n.filter((e=>e!==t))};n.push(t)}else n.push(e)},off:function(e){n=n.filter((t=>t!==e))},clean:function(){n=[]},onProperty:o,onProperties:r,onChange:function(e,t,n=!1){r(Array.isArray(e)?e:[e],t,n)},internalParentKey:i}}({currentIds:{camera:"",microphone:"",audioOutput:""},permission:{camera:!0,microphone:!0,audioOutput:!0},currentCamera:null,currentCameraStream:null,currentMicrophone:null,currentAudioOutputDevice:null,cameraVideoRef:null,volumeRef:null,audioRef:null,audioOutputVisualizationContainer:null,microphoneHasVoice:!1,audioPaused:!0,microphoneList:[],cameraList:[],audioOutputList:[],mediaDeviceDetection:null,audioOutputDetectionMusic:""},{deep:!0,excludeType:[MediaStream,HTMLElement,k]}),z={release:()=>{},releaseStream:e=>{}};function B(e){const t={value:[]},n={value:[]},i={value:[]},o=new k(e?.mediaDeviceDetectionOptions),r=C((t=>{e?.onVolumeChange?.(t)}),50,{trailing:!0});function a(e){r(e)}function s(){o.releaseMicrophone(),globalThis.removeEventListener(I.volumeChangeEventName,a)}function c(e){e?.getTracks().forEach((e=>e.stop()))}return globalThis.addEventListener(I.volumeChangeEventName,a),e?.video&&o.getCameraList().then((e=>e?.map(((e,t)=>(e.InputDeviceInfo.label||Reflect.set(e,"extraLabel","默认摄像头(Built-In) "+(t>0?`${t+1}`:"")),e.deviceId||Reflect.set(e,"extraDeviceId","default"+(t>0?`${t+1}`:"")),e))))).then((n=>{t.value=n||[],e?.onCameraListReady?.(n||[])})),e?.audio&&(o.getMicrophoneList().then((e=>e?.map(((e,t)=>(e.label||Reflect.set(e,"extraLabel","外置麦克风(Built-In) "+(t>0?`${t+1}`:"")),e.deviceId||Reflect.set(e,"extraDeviceId","default"+(t>0?`${t+1}`:"")),e))))).then((t=>{n.value=t||[],e?.onMicrophoneListReady?.(t||[])})),o.getAudioOutputDeviceList().then((e=>e?.map(((e,t)=>(e.label||Reflect.set(e,"extraLabel","外置扬声器(Built-In) "+(t>0?`${t+1}`:"")),e.deviceId||Reflect.set(e,"extraDeviceId","default"+(t>0?`${t+1}`:"")),e))))).then((t=>{i.value=t||[],e?.onAudioOutputListReady?.(t||[])}))),{cameraList:t,microphoneList:n,audioOutputList:i,mediaDeviceDetection:o,release:function(e){s(),e?.forEach((e=>c(e)))},releaseMicrophone:s,releaseStream:c}}var H=class{static sourceNode=null;static audioContext=null;static buffer=null;static analyser=null;static container;static targetAudio;static canvas;static ctx;static isInit=!1;static async create(e,t,n){return this.container=("string"==typeof n?document.querySelector(n):n)||t.parentElement||document.body,this.targetAudio=t,this.canvas=this.#e(),this.ctx=this.canvas.getContext("2d"),this.targetAudio.addEventListener("play",(()=>{this.#t()})),await this.setSinkId(e),this}static#e(){const e=document.createElement("canvas");return e.id="audio-visualization",e.width=this.container.offsetWidth*devicePixelRatio,e.height=2*this.container.offsetHeight/3*devicePixelRatio,this.container.querySelector(`#${e.id}`)?.remove(),this.container.appendChild(e),e}static setSinkId(e){return this.audioContext&&"setSinkId"in AudioContext.prototype?new Promise(((t,n)=>{this.audioContext?.setSinkId(e).then((()=>{t(e)})).catch((e=>{console.debug("AudioVisualization ~ audioContext.setSinkId ~ error:",e),n(e)}))})):Promise.resolve("the 'setSinkId' is unsupported in the AudioContext prototype")}static#n(){if(requestAnimationFrame((()=>{this.#n()})),!this.analyser||!this.buffer||!this.ctx)return;const{width:e,height:t}=this.canvas;this.ctx.clearRect(0,0,e,t),this.analyser.getByteFrequencyData(this.buffer);const n=this.buffer.length/5,i=e/(2*n);this.ctx.fillStyle="#46b9ff";for(let o=0;o<n;o++){const n=this.buffer[o]/255*t,r=o*i+e/2,a=e/2-(o+1)*i,s=t-n;this.ctx.fillRect(r,s,i-2,n),this.ctx.fillRect(a,s,i-2,n)}}static#t(){this.isInit||(this.audioContext=new AudioContext,this.sourceNode=this.audioContext.createMediaElementSource(this.targetAudio),this.analyser=this.audioContext.createAnalyser(),this.sourceNode.connect(this.analyser),this.analyser.fftSize=512,this.analyser.connect(this.audioContext.destination),this.buffer=new Uint8Array(this.analyser.frequencyBinCount),this.isInit=!0)}static updateTargetAudio(e){this.stop(),this.targetAudio=e,this.targetAudio.addEventListener("play",(()=>{this.#t()})),this.start()}static start(){this.#n()}static stop(){this.audioContext?.close(),this.sourceNode?.disconnect(),this.buffer=null,this.analyser=null,this.audioContext=null,this.sourceNode=null,this.isInit=!1}};const W=e=>function(){e.currentIds.camera=this.value,e.currentCamera=e.cameraList.find((e=>e.deviceId===this.value)),Q(e,e.currentCamera)},K=e=>function(){e.currentAudioOutputDevice=e.audioOutputList.find((e=>e.deviceId===this.value)),X(e,this.value)},U=e=>function(){e.currentMicrophone=e.microphoneList.find((e=>e.deviceId===this.value))||null,e.mediaDeviceDetection?.testMicrophone(this.value)};function q(e,t){if(!t.video)return null;const n=O("video",{className:"camera-video",autoplay:!0,muted:!0});e.cameraVideoRef=n,Q(e,e.cameraList.find((t=>t.deviceId===e.currentIds.camera))||e.cameraList[0]);const i=()=>[O("h3",{className:"label"},"摄像头"),O("select",{className:"media-select",value:e.currentIds.camera,placeholder:"请选择一个摄像头",disabled:!e.permission.camera,on:{change:W(e)}},e.cameraList.map((e=>O("option",{value:e.deviceId||e.extraDeviceId},e.InputDeviceInfo.label||e.extraLabel)))),n],o=O("div",{className:"camera"},i());return T(["cameraList","permission.camera"],(()=>{L(o,i)})),o}function F(e,t){if(!t.audio)return null;const n=()=>[e.audioPaused?O("div",{innerHTML:'<svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4417" width="20" height="20"><path d="M92.59163 7.124244v175.409681l588.077547 329.465052-460.111316 245.981852V402.176952l-127.966231-71.344766v686.04357l838.81674-504.876779z" fill="#1296db" p-id="4418"></path></svg>'}):O("div",{innerHTML:'<svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6251" width="20" height="20"><path d="M640 832V192h128v640h-128zM256 192h128v640H256V192z" fill="#1296db" p-id="6252"></path></svg>'})],i=O("div",{className:"sound-play-right"},n());T("audioPaused",(()=>{L(i,n)}));const o=()=>O("select",{value:e.currentIds.audioOutput,className:"media-select",placeholder:"请选择一个扬声器",disabled:!e.permission.audioOutput||!e.permission.microphone,on:{change:K(e)}},e.audioOutputList.map((e=>O("option",{value:e.deviceId||e.extraDeviceId},e.label||e.extraLabel)))),r=()=>{const t=O("div",{className:"audio-output-visualization-container"});return e.audioOutputVisualizationContainer=t,t},a=()=>{const t=O("audio",{className:"audio-output"});return e.audioRef=t,O("div",{className:["sound-play",e.permission.audioOutput&&e.permission.microphone?"":"disabled"].filter(Boolean).join(" "),on:{click:_(e)}},[O("span",null,"播放声音"),t,i])},s=()=>O("select",{value:e.currentIds.microphone,className:"media-select",placeholder:"请选择一个麦克风",disabled:!e.permission.microphone,on:{change:U(e)}},e.microphoneList.map((e=>O("option",{value:e.deviceId||e.extraDeviceId},e.label||e.extraLabel))));let c=o(),u=a(),l=r(),d=s();const h=O("div",{className:"microphone-sound"},[O("h3",{className:"label"},"扬声器"),c,u,l,O("h3",{className:"label",style:"margin-top: 20px"},"麦克风"),d,(()=>{const t=new Array(10).fill(0).map(((e,t)=>O("div",{className:"line-gap",style:{left:10*t+"%"}}))),n=O("div",{className:"microphone-voice"});return e.volumeRef=n,O("div",{className:"microphone-detection"},[...t,n])})()]);return T(["audioOutputList","microphoneList","permission","permission.microphone","permission.audioOutput"],(()=>{const[e,t,n,i]=function(e,t){const n=[];return t.forEach((t=>{if(t.item.parentElement===e){const i=t.render();e.insertBefore(i,t.item),t.item.remove(),n.push(i)}})),n}(h,[{item:c,render:o},{item:u,render:a},{item:l,render:r},{item:d,render:s}]);c=e,u=t,d=i,l=n})),T(["audioRef"],C((e=>{H.updateTargetAudio(e)}),1e3,{trailing:!0})),h}async function Q(e,t){e?.cameraVideoRef&&t&&(e.currentCameraStream&&e.currentCameraStream.getTracks().forEach((e=>e.stop())),e.currentCameraStream=await navigator.mediaDevices.getUserMedia({audio:!1,video:{deviceId:t.InputDeviceInfo.deviceId,width:t.width,height:t.height}}),e.cameraVideoRef.srcObject=e.currentCameraStream)}const X=async(e,t)=>{if(e?.audioRef&&t)if(e.currentIds.audioOutput=t,e.audioRef.paused||e.audioRef.pause(),e.audioRef.src||(e.audioRef.src=e.audioOutputDetectionMusic),H.isInit)try{await H.setSinkId(t)}catch{await H.setSinkId(t)}else{(await H.create(t,e.audioRef,e.audioOutputVisualizationContainer)).start()}},_=e=>async function(){e?.audioRef&&e.permission.audioOutput&&e.permission.microphone&&(e.audioRef.paused&&e.currentIds.audioOutput?(await X(e,e.currentIds.audioOutput),e.audioRef.play()):e.audioRef.pause())};function J(e,t,n){const i=function(e,t){const n=()=>{let n=null,i=null,o=null;return t.video&&!e.permission.camera&&(n=O("div",{className:"no-permission"},"未开启摄像头权限，请在开启权限后重试")),t.audio&&!e.permission.microphone&&(i=O("div",{className:"no-permission"},"未开启麦克风权限，请在开启权限后重试")),t.audio&&!e.permission.audioOutput&&(o=O("div",{className:"no-permission"},"未开启扬声器权限，请在开启权限后重试")),[n,i,o].filter((e=>!!e))},i=O("div",{className:"permission"},n());return T(["permission","permission.camera","permission.microphone","permission.audioOutput"],(()=>{L(i,n)})),i}(t,n);return[i,O("main",{className:"main"},[q(t,n),F(t,n)].filter((e=>!!e))),O("div",{className:"acton-bar"},[O("button",{className:"cancel-btn",on:{click:()=>{n.onClose?.(),"close"in e&&"function"==typeof e.close&&e.close()}}},"取消"),O("button",{className:"confirm-btn",on:{click:()=>{const i=Object.entries(t.currentIds).filter((([e])=>e!==$)).map((([e,t])=>`${e}:${t}`)).join("|");n.onClose?.(i),"close"in e&&"function"==typeof e.close&&e.close(i)}}},"确定")])]}var Y=class{options;store;customDialogContentCreator;constructor(e,t,n){this.options=e,this.store=t,this.customDialogContentCreator=n,e.testAudioURL&&(t.audioOutputDetectionMusic=e.testAudioURL)}#i=e=>{this.options.onVolumeChange?.(e),this.store.volumeRef&&(!this.store.microphoneHasVoice&&e.detail>0&&(this.store.microphoneHasVoice=!0),![-1/0].includes(e.detail)&&e.detail>=0&&E("--volume-width",`${e.detail<1?1+e.detail:e.detail}%`,this.store.volumeRef),[-1/0].includes(e.detail)&&E("--volume-width",`${Math.random()}%`,this.store.volumeRef))};#o=e=>{console.log("onGetCameraError",e?.message),this.store.permission.camera=!1};#r=e=>{console.log("onGetMicrophoneError",e?.message),this.store.permission.microphone=!1};#a=e=>{console.log("onGetAudioOutputError",e?.message),this.store.permission.audioOutput=!1};#s=e=>{e[0]?(this.store.permission.camera=!0,this.store.currentCamera=e[0],this.store.currentIds.camera=this.store.currentCamera?.InputDeviceInfo.deviceId,this.store.cameraList=e,Q(this.store,this.store.currentCamera)):this.store.permission.camera=!1};#c=e=>{if(!e[0])return this.store.permission.microphone=!1,void(this.store.microphoneList=[]);this.store.permission.microphone=!0,this.store.currentMicrophone=e[0],this.store.currentIds.microphone=this.store.currentMicrophone.extraDeviceId||this.store.currentMicrophone.deviceId,this.store.microphoneList=e,this.store.mediaDeviceDetection?.testMicrophone(this.store.currentIds.microphone)};#u=e=>{e&&(e.onplay=()=>{this.store.audioPaused=!1,console.debug("[[play]]",this.store.audioOutputDetectionMusic)},e.onpause=()=>{this.store.audioPaused=!0,console.debug("[[paused]]",this.store.audioOutputDetectionMusic)})};#l=e=>{e[0]?(this.store.permission.audioOutput=!0,this.store.currentAudioOutputDevice=e[0],this.store.currentIds.audioOutput=this.store.currentAudioOutputDevice.extraDeviceId||this.store.currentAudioOutputDevice.deviceId,this.store.audioOutputList=e,X(this.store,this.store.currentIds.audioOutput),this.#u(this.store.audioRef),T(["audioRef"],(e=>{this.#u(e)}))):this.store.permission.audioOutput=!1};create(e){const{mediaDeviceDetection:t,release:n,microphoneList:i,cameraList:o,audioOutputList:r,releaseStream:a}=B({...this.options,onVolumeChange:this.#i,onCameraListReady:this.#s,onMicrophoneListReady:this.#c,onAudioOutputListReady:this.#l,mediaDeviceDetectionOptions:{onGetCameraError:this.#o,onGetMicrophoneError:this.#r,onGetAudioOutputError:this.#a}}),s=t.watchPermissions(((e,t)=>{this.store.permission[e]="granted"===t}));z.release=n,z.releaseStream=a,this.store.mediaDeviceDetection=t,this.store.microphoneList=i.value,this.store.cameraList=o.value,this.store.audioOutputList=r.value;const c="function"==typeof this.customDialogContentCreator?this.customDialogContentCreator(e,this.store,this.options):J(e,this.store,this.options);e.append.apply(e,c);return()=>{H.stop(),s.abort(),n([this.store.currentCameraStream])}}},Z=class{options;customDialogContentCreator;shadowRoot;style="";styleTagId=`${M}style`;container;dispose=()=>{};constructor(e){const{shadowRoot:t,container:n,options:i,customDialogContentCreator:o,style:r}=e;this.shadowRoot=t,this.container=n,this.options=i,this.style=r||"",this.customDialogContentCreator=o?.bind(this),this.connectView()}injectStyle(e){!function(e,t=`global-customer-css-${Date.now()}`,n=document){const i=document.createElement("style");i.id=t;const o=document.createTextNode(e);i.appendChild(o),n===document?n.head.appendChild(i):n.insertBefore(i,n.firstChild)}(e||this.style,this.styleTagId,this.shadowRoot)}connectView(){this.injectStyle();const e=new Y(this.options,G,this.customDialogContentCreator).create(this.container);this.shadowRoot.appendChild(this.container),this.dispose=e}deviceOk(){let e=!0,t=!0;return this.options.video&&(t=G.permission.camera&&!!G.currentCameraStream),this.options.audio&&(e=G.permission.microphone&&!!G.currentMicrophone&&G.microphoneHasVoice),e&&t}getCurrentDeviceIds(){const e={...G.currentIds};return Reflect.deleteProperty(e,$),e}disconnected(){V(),this.dispose()}},ee=class extends HTMLElement{mediaDeviceDetection;dialog;constructor(e,t,n){super(),this.dialog=e,D(this.dialog,S);const i=this.attachShadow({mode:"open"});this.mediaDeviceDetection=new Z({shadowRoot:i,container:this.dialog,options:t,customDialogContentCreator:n,style:P}),this.dialog.addEventListener("close",(e=>{this.remove()}))}connectedCallback(){this.dialog.showModal()}disconnectedCallback(){this.mediaDeviceDetection.disconnected()}adoptedCallback(){}attributeChangedCallback(e,t,n){console.debug(`[MediaDeviceDetectionDialogElement] 属性 ${e} 已由 ${t} 变更为 ${n}`)}},te=class extends HTMLElement{mediaDeviceDetection;container;constructor(e,t){super();const n=this.attachShadow({mode:"open"});this.container=document.createElement("div"),D(this.container,N),this.mediaDeviceDetection=new Z({shadowRoot:n,container:this.container,options:e,style:j,customDialogContentCreator:t})}connectedCallback(){}disconnectedCallback(){this.mediaDeviceDetection.disconnected()}adoptedCallback(){}attributeChangedCallback(e,t,n){console.debug(`[MediaDeviceDetectionPanelElement] 属性 ${e} 已由 ${t} 变更为 ${n}`)}};function ne(e,t,n){customElements.get(e)||customElements.define(e,t,n?{extends:n}:void 0)}function ie(e,t,n){var i;return(i=e,new y(i,x)).with("dialog",(()=>(ne(S,ee),new ee(document.createElement("dialog"),t,n)))).with("panel",(()=>(ne(N,te),new te(t,n)))).exhaustive()}function oe(e={video:!0,audio:!0},t){const{promise:n,resolve:i}=Promise.withResolvers(),o=ie("dialog",e,t);return o.dialog.addEventListener("close",(()=>{const e={returnValue:o.dialog.returnValue,currentIds:o.mediaDeviceDetection.getCurrentDeviceIds(),deviceOk:o.mediaDeviceDetection.deviceOk()};i(e)})),document.body.append(o),n}function re(e={video:!0,audio:!0},t){const n=ie("panel",e,t);return document.body.append(n),n}export{oe as displayDialogView,re as displayPanelView,B as useMediaDeviceDetection};