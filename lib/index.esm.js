function e(e,t,i={}){let n,o=0;return(...r)=>{const a=Date.now();o||!1!==i.leading||(o=a);const s=t-(a-o);s<0?(n&&(clearTimeout(n),n=null),o=a,e(...r)):n||!1===i.trailing||(n=window.setTimeout((()=>{o=!1===i.leading?0:(new Date).getTime(),n=null,e(...r)}),s))}}function t(e,t,i){const n=document.createElement(e);return t&&Object.entries(t).forEach((([e,t])=>{"arrts"===e&&"object"==typeof t&&null!==t?Object.entries(t).forEach((([e,t])=>{n.setAttribute(e,t)})):"on"===e&&"object"==typeof t&&null!==t?Object.entries(t).forEach((([e,t])=>{n.addEventListener(e,"function"==typeof t?t.bind(n):{...t,handleEvent:t.handleEvent.bind(n)})})):"style"===e?"object"==typeof t&&null!==t?Object.entries(t).forEach((([e,t])=>{Reflect.set(n.style,e,t)})):"string"==typeof t&&Reflect.set(n.style,"cssText",t):"arrts"!==e&&"on"!==e&&"style"!==e&&Reflect.set(n,e,t)})),i&&n.append.apply(n,Array.isArray(i)?i:[i]),n}function i(e,t){const i=t(),n=Array.isArray(i)?i:[i];return Array.from(e.childNodes).forEach((t=>e.removeChild(t))),e.append.apply(e,n),e}const n=function(e){const t=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(t)}("registerProcessor('volume-detection-processor',class VolumeDetectionProcessor extends AudioWorkletProcessor{constructor(){super()}process(inputs){const input=inputs[0][0];const buffer=new Float32Array(input);const maxVal=Math.max(...buffer);this.port.postMessage({type:'volumeChange',volume:maxVal*100});return true}});");var o={volumeChangeEventName:`media-device-detection-volume-change-${Date.now()}`,defaultCameraList:[{label:"4K(UHD)",width:3840,height:2160,ratio:"16:9"},{label:"4K(UHD)",width:2160,height:3840,ratio:"9:16"},{label:"2K",width:2560,height:1440,ratio:"16:9"},{label:"2K",width:1440,height:2560,ratio:"9:16"},{label:"1080p(FHD)",width:1920,height:1080,ratio:"16:9"},{label:"1080p(FHD)",width:1080,height:1920,ratio:"9:16"},{label:"UXGA",width:1600,height:1200,ratio:"4:3"},{label:"UXGA",width:1200,height:1600,ratio:"3:4"},{label:"720p(HD)",width:1280,height:720,ratio:"16:9"},{label:"720p(HD)",width:720,height:1280,ratio:"9:16"},{label:"SVGA",width:800,height:600,ratio:"4:3"},{label:"SVGA",width:600,height:800,ratio:"3:4"},{label:"VGA",width:640,height:480,ratio:"4:3"},{label:"360p(nHD)",width:640,height:360,ratio:"16:9"},{label:"CIF",width:352,height:288,ratio:"4:3"},{label:"QVGA",width:320,height:240,ratio:"4:3"},{label:"QCIF",width:176,height:144,ratio:"4:3"},{label:"QQVGA",width:160,height:120,ratio:"4:3"}]},r=class{audioContext=null;audioWorkletNode=null;micStream=null;micStreamSource=null;onGetCameraError=e=>{console.debug("getCameraDeviceList error",e)};onGetMicrophoneError=e=>{console.debug("getMicrophoneDeviceList error",e)};onGetAudioOutputError=e=>{console.debug("getAudioOutputDeviceList error",e)};constructor(e){"function"==typeof e?.onGetCameraError&&(this.onGetCameraError=e.onGetCameraError),"function"==typeof e?.onGetMicrophoneError&&(this.onGetMicrophoneError=e.onGetMicrophoneError),"function"==typeof e?.onGetAudioOutputError&&(this.onGetAudioOutputError=e.onGetAudioOutputError)}watchPermissions(e){const t=new AbortController;return(async()=>{const i=await navigator.permissions.query({name:"microphone"}),n=await navigator.permissions.query({name:"camera"});i.addEventListener("change",(t=>{const i=t.target;e("microphone",i.state,t)}),{signal:t.signal}),n.addEventListener("change",(t=>{const i=t.target;e("camera",i.state,t)}),{signal:t.signal})})(),t}async getCameraList(){try{const e=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)),t=async e=>{try{const t=await navigator.mediaDevices.getUserMedia({video:{deviceId:e.deviceId}}),i=t.getTracks().find((e=>"video"===e.kind));if(!i)return null;const n=Object.assign({},{InputDeviceInfo:e},i.getCapabilities());return t.getTracks().forEach((e=>e.stop())),n}catch(e){return this.onGetCameraError(e),null}},i=e.map(t),n=await Promise.allSettled(i),o=n.filter((e=>"fulfilled"===e.status&&e.value)).map((e=>e.value));return o.sort(((e,t)=>(e.width?.max||0)-(t.width?.max||0)))}catch(e){this.onGetCameraError(e)}}getResolution(e){return o.defaultCameraList.filter((t=>t.width<=(e.width?.max||0)&&t.height<=(e.height?.max||0)))}async getMicrophoneList(){try{return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"audioinput"===e.kind))}catch(e){this.onGetMicrophoneError(e)}}async getAudioOutputDeviceList(){try{return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"audiooutput"===e.kind))}catch(e){this.onGetAudioOutputError(e)}}async testMicrophone(e){try{this.audioContext?this.closeCurrentMicrophone():(this.audioContext=new(globalThis.AudioContext||globalThis.webkitAudioContext),await this.audioContext.audioWorklet.addModule(n),this.audioWorkletNode=new AudioWorkletNode(this.audioContext,"volume-detection-processor"),this.audioWorkletNode.port.onmessage=e=>{if("volumeChange"===e.data.type){const t=e.data.volume;globalThis.dispatchEvent(new CustomEvent(o.volumeChangeEventName,{detail:t}))}},this.audioWorkletNode.connect(this.audioContext.destination));const t=await navigator.mediaDevices.getUserMedia({audio:{deviceId:e,echoCancellation:!0}});this.micStream=t,this.micStreamSource=this.audioContext.createMediaStreamSource(this.micStream),this.audioWorkletNode&&this.micStreamSource.connect(this.audioWorkletNode)}catch(e){this.onGetMicrophoneError(e)}}closeCurrentMicrophone(){this.audioWorkletNode&&this.micStreamSource?.disconnect(this.audioWorkletNode),this.micStream?.getAudioTracks().forEach((e=>{e.stop()}))}releaseMicrophone(){this.closeCurrentMicrophone(),this.audioWorkletNode?.disconnect(),this.audioContext=null}};function a(t){const i={value:[]},n={value:[]},a={value:[]},s=new r(t?.mediaDeviceDetectionOptions),c=e((e=>{t?.onVolumeChange?.(e)}),50);function u(e){c(e)}function d(){s.releaseMicrophone(),globalThis.removeEventListener(o.volumeChangeEventName,u)}function l(e){e?.getTracks().forEach((e=>e.stop()))}return globalThis.addEventListener(o.volumeChangeEventName,u),t?.video&&s.getCameraList().then((e=>e?.map(((e,t)=>(e.InputDeviceInfo.label||Reflect.set(e,"extraLabel","默认摄像头(Built-In) "+(t>0?`${t+1}`:"")),e.deviceId||Reflect.set(e,"extraDeviceId","default"+(t>0?`${t+1}`:"")),e))))).then((e=>{i.value=e||[],t?.onCameraListReady?.(e||[])})),t?.audio&&(s.getMicrophoneList().then((e=>e?.map(((e,t)=>(e.label||Reflect.set(e,"extraLabel","外置麦克风(Built-In) "+(t>0?`${t+1}`:"")),e.deviceId||Reflect.set(e,"extraDeviceId","default"+(t>0?`${t+1}`:"")),e))))).then((e=>{n.value=e||[],t?.onMicrophoneListReady?.(e||[])})),s.getAudioOutputDeviceList().then((e=>e?.map(((e,t)=>(e.label||Reflect.set(e,"extraLabel","外置扬声器(Built-In) "+(t>0?`${t+1}`:"")),e.deviceId||Reflect.set(e,"extraDeviceId","default"+(t>0?`${t+1}`:"")),e))))).then((e=>{a.value=e||[],t?.onAudioOutputListReady?.(e||[])}))),{cameraList:i,microphoneList:n,audioOutputList:a,mediaDeviceDetection:s,release:function(e){d(),e?.forEach((e=>l(e)))},releaseMicrophone:d,releaseStream:l}}var s=class{static sourceNode=null;static audioContext=null;static buffer=null;static analyser=null;static container;static targetAudio;static canvas;static ctx;static isInit=!1;static async create(e,t,i){return this.container=("string"==typeof i?document.querySelector(i):i)||t.parentElement||document.body,this.targetAudio=t,this.canvas=this.#e(),this.ctx=this.canvas.getContext("2d"),this.targetAudio.addEventListener("play",(()=>{this.#t()})),await this.setSinkId(e),this}static#e(){const e=document.createElement("canvas");return e.id="audio-visualization",e.width=this.container.offsetWidth*devicePixelRatio,e.height=2*this.container.offsetHeight/3*devicePixelRatio,this.container.querySelector(`#${e.id}`)?.remove(),this.container.appendChild(e),e}static setSinkId(e){return this.audioContext&&"setSinkId"in AudioContext.prototype?new Promise(((t,i)=>{this.audioContext?.setSinkId(e).then((()=>{t(e)})).catch((e=>{console.debug("AudioVisualization ~ audioContext.setSinkId ~ error:",e),i(e)}))})):Promise.resolve("the 'setSinkId' is unsupported in the AudioContext prototype")}static#i(){if(requestAnimationFrame((()=>{this.#i()})),!this.analyser||!this.buffer||!this.ctx)return;const{width:e,height:t}=this.canvas;this.ctx.clearRect(0,0,e,t),this.analyser.getByteFrequencyData(this.buffer);const i=this.buffer.length/5,n=e/(2*i);this.ctx.fillStyle="#46b9ff";for(let o=0;o<i;o++){const i=this.buffer[o]/255*t,r=o*n+e/2,a=e/2-(o+1)*n,s=t-i;this.ctx.fillRect(r,s,n-2,i),this.ctx.fillRect(a,s,n-2,i)}}static#t(){this.isInit||(this.audioContext=new AudioContext,this.sourceNode=this.audioContext.createMediaElementSource(this.targetAudio),this.analyser=this.audioContext.createAnalyser(),this.sourceNode.connect(this.analyser),this.analyser.fftSize=512,this.analyser.connect(this.audioContext.destination),this.buffer=new Uint8Array(this.analyser.frequencyBinCount),this.isInit=!0)}static updateTargetAudio(e){this.stop(),this.targetAudio=e,this.targetAudio.addEventListener("play",(()=>{this.#t()})),this.start()}static start(){this.#i()}static stop(){this.audioContext?.close(),this.sourceNode?.disconnect(),this.buffer=null,this.analyser=null,this.audioContext=null,this.sourceNode=null,this.isInit=!1}};const c="media-device-detection-",u=`${c}dialog`,d=`${c}panel`,l=".media-device-detection-dialog {\n  --action-bar-height: 38px;\n  --width: clamp(500px, 80vw, 1000px);\n  --height: clamp(300px, 60vh, 500px);\n\n  display: flex;\n  flex-direction: column;\n  width: var(--width);\n  height: var(--height);\n  border-color: transparent;\n\n  .acton-bar {\n    height: var(--action-bar-height);\n    display: flex;\n    align-items: center;\n    justify-content: flex-end;\n    gap: 12px;\n\n    .cancel-btn {\n      box-sizing: border-box;\n      padding: 5px 20px;\n      font-size: 14px;\n      color: #1e90ff;\n      border-radius: 2px;\n      cursor: pointer;\n      outline: none;\n      border: 1px solid #1e90ff;\n      background-color: #fff;\n    }\n\n    .confirm-btn {\n      box-sizing: border-box;\n      padding: 5px 20px;\n      font-size: 14px;\n      color: #fff;\n      border-radius: 2px;\n      cursor: pointer;\n      outline: none;\n      border: none;\n      background: #1e90ff;\n    }\n  }\n\n  .permission {\n    display: none;\n  }\n\n  .permission:has(div) {\n    display: flex;\n    flex-direction: column;\n    position: fixed;\n    top: 30px;\n    left: 50%;\n    transform: translateX(-50%);\n    color: #ffffff;\n    background: #ff0000;\n    padding: 10px 20px;\n    border: 1px solid #f40;\n    border-radius: 4px;\n    justify-content: center;\n    align-items: center;\n    line-height: 20px;\n    font-size: 16px;\n    .no-permission {\n      margin-top: 4px;\n    }\n  }\n\n  .main {\n    display: flex;\n    justify-content: center;\n    gap: 10%;\n    flex-grow: 1;\n\n    .camera {\n      flex: 1;\n    }\n\n    .label {\n      margin: 0 0 10px 0;\n      color: #999;\n      font-weight: 400;\n    }\n\n    .media-select {\n      width: 100%;\n      padding: 8px 0;\n      border: 1px solid #eee;\n      color: #666;\n      cursor: pointer;\n      outline: none;\n    }\n    .camera-video {\n      border: 1px solid #eaeaea;\n      margin-top: 20px;\n      width: 100%;\n      border-radius: 4px;\n      min-height: 270px;\n      background-color: #eaeaea;\n    }\n\n    .audio-output-visualization-container {\n      width: 100%;\n      min-height: 160px;\n      margin-block-start: 12px;\n      outline: 1px solid #eee;\n      background-color: #1d1d1d;\n      display: flex;\n      flex-direction: column;\n      justify-content: flex-end;\n    }\n\n    .microphone-sound {\n      flex: 1;\n\n      .sound-play {\n        width: 100%;\n        height: 40px;\n        display: flex;\n        align-items: center;\n        border-radius: 2px;\n        border: 1px solid #dcdfe6;\n        margin-top: 20px;\n        padding: 0px 8px;\n        box-sizing: border-box;\n        cursor: pointer;\n\n        .sound-play-right {\n          margin-left: auto;\n        }\n      }\n\n      .microphone-detection {\n        width: 100%;\n        height: 10px;\n        margin-top: 10px;\n        border-radius: 2px;\n        overflow: hidden;\n        background-color: #eaeaea;\n        position: relative;\n\n        .line-gap {\n          height: 100%;\n          width: 2px;\n          background-color: #ffffff;\n          position: absolute;\n          top: 0;\n        }\n\n        .microphone-voice {\n          --volume-width: 0;\n          width: var(--volume-width);\n          height: 100%;\n          background-color: #2980fb;\n        }\n      }\n    }\n  }\n\n  .disabled {\n    background-color: #f5f7fa;\n    color: #b1b4ba;\n    cursor: not-allowed !important;\n  }\n}\n",p=".media-device-detection-panel {\n  --action-bar-height: 60px;\n  --width: clamp(500px, 80vw, 1000px);\n  --height: clamp(300px, 50vh, 500px);\n\n  display: flex;\n  flex-direction: column;\n  width: var(--width);\n  height: var(--height);\n  border-color: transparent;\n}\n",{value:h,onChange:m,clean:f}=function(e,t={deep:!1}){let i=[];const n="__parentKey";function o(e,t,n=!1){const o="number"==typeof e?String(e):e;if(t.watchProperties?t.watchProperties.push(o):t.watchProperties=[o],!i.includes(t)){if(n){const e=(n,o,r,a)=>{t(n,o,r,a),i=i.filter((t=>t!==e))};return e.watchProperties=[o],void i.push(e)}i.push(t)}}function r(e,t,i=!1){e.forEach((e=>{o(e,t,i)}))}function a(e,t,i,o,r,a){i!==n&&(e.watchProperties?e.watchProperties?.includes(i)&&e(r,a,o,i):e(o,i,r,a))}const s={get(e,i){const o=Reflect.get(e,i),r=!!t.excludeType&&t.excludeType.some((e=>o instanceof e));if(!t?.deep||"object"!=typeof o||null===o||r)return o;const a=new Proxy(o,s),c=Reflect.get(e,n)||"";console.debug("[[GET Object]]",e,c,o);const u=[c,i].filter(Boolean).join(".");return Reflect.set(a,n,u),a},set(e,t,o){const r=Reflect.get(e,t);if(r===o)return!0;const s=[Reflect.get(e,n)||"",t].filter(Boolean).join(".");return console.debug("[[SET Object]]",e,s,o),Reflect.set(e,t,o),i.forEach((i=>a(i,0,t,e,o,r))),!0},deleteProperty(e,t){const o=Reflect.get(e,t),r=Reflect.deleteProperty(e,t);[Reflect.get(e,n)||"",t].filter(Boolean).join(".");return i.forEach((i=>a(i,0,t,e,void 0,o))),r},defineProperty(e,t,o){const r=Reflect.get(e,t),s=Reflect.defineProperty(e,t,o);[Reflect.get(e,n)||"",t].filter(Boolean).join(".");return i.forEach((i=>a(i,0,t,e,o?.value||o?.get?.(),r))),s}};return{value:new Proxy(e,s),on:function(e,t=!1){if(!i.includes(e))if(t){const t=(n,o,r,a)=>{e(n,o,r,a),i=i.filter((e=>e!==t))};i.push(t)}else i.push(e)},off:function(e){i=i.filter((t=>t!==e))},clean:function(){i=[]},onProperty:o,onProperties:r,onChange:function(e,t,i=!1){r(Array.isArray(e)?e:[e],t,i)}}}({currentIds:{camera:"",microphone:"",audioOutput:""},permission:{camera:!0,microphone:!0,audioOutput:!0},currentCamera:null,currentCameraStream:null,currentMicrophone:null,currentAudioOutputDevice:null,cameraVideoRef:null,volumeRef:null,audioRef:null,audioOutputVisualizationContainer:null,currentAudioOutputStream:null,microphoneHasVoice:!1,audioPaused:!0,microphoneList:[],cameraList:[],audioOutputList:[],mediaDeviceDetection:null,audioOutputDetectionMusic:"test.mp3"},{deep:!0,excludeType:[MediaStream,HTMLElement,r]}),v={release:()=>{},releaseStream:e=>{}},g=e=>function(){e.currentIds.camera=this.value,e.currentCamera=e.cameraList.find((e=>e.deviceId===this.value)),E(e,e.currentCamera)},x=e=>function(){e.currentAudioOutputDevice=e.audioOutputList.find((e=>e.deviceId===this.value)),I(e,this.value)},b=e=>function(){e.currentMicrophone=e.microphoneList.find((e=>e.deviceId===this.value))||null,e.mediaDeviceDetection?.testMicrophone(this.value)};function y(e,n){if(!n.video)return null;const o=t("video",{className:"camera-video",autoplay:!0,muted:!0});e.cameraVideoRef=o,E(e,e.cameraList.find((t=>t.deviceId===e.currentIds.camera))||e.cameraList[0]);const r=()=>[t("h3",{className:"label"},"摄像头"),t("select",{className:"media-select",value:e.currentIds.camera,placeholder:"请选择一个摄像头",disabled:!e.permission.camera,on:{change:g(e)}},e.cameraList.map((e=>t("option",{value:e.deviceId||e.extraDeviceId},e.InputDeviceInfo.label||e.extraLabel)))),o],a=t("div",{className:"camera"},r());return m(["cameraList","permission.camera"],(()=>{i(a,r)})),a}function w(n,o){if(!o.audio)return null;const r=()=>[n.audioPaused?t("div",{innerHTML:'<svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4417" width="20" height="20"><path d="M92.59163 7.124244v175.409681l588.077547 329.465052-460.111316 245.981852V402.176952l-127.966231-71.344766v686.04357l838.81674-504.876779z" fill="#1296db" p-id="4418"></path></svg>'}):t("div",{innerHTML:'<svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6251" width="20" height="20"><path d="M640 832V192h128v640h-128zM256 192h128v640H256V192z" fill="#1296db" p-id="6252"></path></svg>'})],a=t("div",{className:"sound-play-right"},r());m("audioPaused",(()=>{i(a,r)}));const c=()=>t("select",{value:n.currentIds.audioOutput,className:"media-select",placeholder:"请选择一个扬声器",disabled:!n.permission.audioOutput||!n.permission.microphone,on:{change:x(n)}},n.audioOutputList.map((e=>t("option",{value:e.deviceId||e.extraDeviceId},e.label||e.extraLabel)))),u=()=>{const e=t("div",{className:"audio-output-visualization-container"});return n.audioOutputVisualizationContainer=e,e},d=()=>{const e=t("audio",{className:"audio-output"});return n.audioRef=e,t("div",{className:["sound-play",n.permission.audioOutput&&n.permission.microphone?"":"disabled"].filter(Boolean).join(" "),on:{click:A(n)}},[t("span",null,"播放声音"),e,a])},l=()=>t("select",{value:n.currentIds.microphone,className:"media-select",placeholder:"请选择一个麦克风",disabled:!n.permission.microphone,on:{change:b(n)}},n.microphoneList.map((e=>t("option",{value:e.deviceId||e.extraDeviceId},e.label||e.extraLabel))));let p=c(),h=d(),f=u(),v=l();const g=t("div",{className:"microphone-sound"},[t("h3",{className:"label"},"扬声器"),p,h,f,t("h3",{className:"label",style:"margin-top: 20px"},"麦克风"),v,(()=>{const e=new Array(10).fill(0).map(((e,i)=>t("div",{className:"line-gap",style:{left:10*i+"%"}}))),i=t("div",{className:"microphone-voice"});return n.volumeRef=i,t("div",{className:"microphone-detection"},[...e,i])})()]);return m(["audioOutputList","microphoneList","permission","permission.microphone","permission.audioOutput"],(()=>{const[e,t,i,n]=function(e,t){const i=[];return t.forEach((t=>{if(t.item.parentElement===e){const n=t.render();e.insertBefore(n,t.item),t.item.remove(),i.push(n)}})),i}(g,[{item:p,render:c},{item:h,render:d},{item:f,render:u},{item:v,render:l}]);p=e,h=t,v=n,f=i})),m(["audioRef"],e((e=>{s.updateTargetAudio(e)}),1e3,{trailing:!0})),g}function C(e,n,o){const r=function(e,n){const o=()=>{let i=null,o=null,r=null;return n.video&&!e.permission.camera&&(i=t("div",{className:"no-permission"},"未开启摄像头权限，请在开启权限后重试")),n.audio&&!e.permission.microphone&&(o=t("div",{className:"no-permission"},"未开启麦克风权限，请在开启权限后重试")),n.audio&&!e.permission.audioOutput&&(r=t("div",{className:"no-permission"},"未开启扬声器权限，请在开启权限后重试")),[i,o,r].filter((e=>!!e))},r=t("div",{className:"permission"},o());return m(["permission","permission.camera","permission.microphone","permission.audioOutput"],(()=>{i(r,o)})),r}(n,o);return[r,t("main",{className:"main"},[y(n,o),w(n,o)].filter((e=>!!e))),t("div",{className:"acton-bar"},[t("button",{className:"cancel-btn",on:{click:()=>{e.close()}}},"取消"),t("button",{className:"confirm-btn",on:{click:()=>{e.close(Object.entries(n.currentIds).map((([e,t])=>`${e}:${t}`)).join("|"))}}},"确定")])]}async function E(e,t){e?.cameraVideoRef&&t&&(e.currentCameraStream&&e.currentCameraStream.getTracks().forEach((e=>e.stop())),e.currentCameraStream=await navigator.mediaDevices.getUserMedia({audio:!1,video:{deviceId:t.InputDeviceInfo.deviceId,width:t.width,height:t.height}}),e.cameraVideoRef.srcObject=e.currentCameraStream)}const I=async(e,t)=>{if(e?.audioRef&&t)if(e.currentIds.audioOutput=t,e.currentAudioOutputStream&&e.currentAudioOutputStream.getTracks().forEach((e=>e.stop())),e.audioRef.paused||e.audioRef.pause(),e.audioRef.src||(e.audioRef.src=e.audioOutputDetectionMusic),s.isInit)try{await s.setSinkId(t)}catch{await s.setSinkId(t)}else{(await s.create(t,e.audioRef,e.audioOutputVisualizationContainer)).start()}},A=e=>async function(){e?.audioRef&&e.permission.audioOutput&&e.permission.microphone&&(e.audioRef.paused&&e.currentIds.audioOutput?(await I(e,e.currentIds.audioOutput),e.audioRef.play()):(e.audioRef.pause(),e.currentAudioOutputStream&&v.releaseStream(e.currentAudioOutputStream)))};function L(e,t,i){e.testAudioURL&&(t.audioOutputDetectionMusic=e.testAudioURL);const n=i=>{e.onVolumeChange?.(i),t.volumeRef&&(!t.microphoneHasVoice&&i.detail>0&&(t.microphoneHasVoice=!0),![-1/0].includes(i.detail)&&i.detail>=0&&function(e,t,i=document.documentElement,n){i||console.log(`[setCssVar ${e}: ${t} error] dom may not exist`,i),(Array.isArray(i)?i:[i]).forEach((i=>{"string"==typeof i?document.querySelector(i)?.style.setProperty(e,t,n):i?.style.setProperty(e,t,n)}))}("--volume-width",`${i.detail<1?1+i.detail:i.detail}%`,t.volumeRef))},o=e=>{console.log("onGetCameraError",e?.message),t.permission.camera=!1},r=e=>{console.log("onGetMicrophoneError",e?.message),t.permission.microphone=!1},s=e=>{console.log("onGetAudioOutputError",e?.message),t.permission.audioOutput=!1},c=e=>{e[0]?(t.permission.camera=!0,t.currentCamera=e[0],t.currentIds.camera=t.currentCamera?.InputDeviceInfo.deviceId,t.cameraList=e,E(t,t.currentCamera)):t.permission.camera=!1},u=e=>{if(!e[0])return t.permission.microphone=!1,void(t.microphoneList=[]);t.permission.microphone=!0,t.currentMicrophone=e[0],t.currentIds.microphone=t.currentMicrophone.extraDeviceId||t.currentMicrophone.deviceId,t.microphoneList=e,t.mediaDeviceDetection?.testMicrophone(t.currentIds.microphone)},d=e=>{e&&(e.onplay=()=>{t.audioPaused=!1,console.debug("[[play]]",t.audioOutputDetectionMusic)},e.onpause=()=>{t.audioPaused=!0,console.debug("[[paused]]",t.audioOutputDetectionMusic)})},l=e=>{e[0]?(t.permission.audioOutput=!0,t.currentAudioOutputDevice=e[0],t.currentIds.audioOutput=t.currentAudioOutputDevice.extraDeviceId||t.currentAudioOutputDevice.deviceId,t.audioOutputList=e,I(t,t.currentIds.audioOutput),d(t.audioRef),m(["audioRef"],(e=>{d(e)}))):t.permission.audioOutput=!1};return function(d){const{mediaDeviceDetection:p,release:h,microphoneList:m,cameraList:f,audioOutputList:g,releaseStream:x}=a({...e,onVolumeChange:n,onCameraListReady:c,onMicrophoneListReady:u,onAudioOutputListReady:l,mediaDeviceDetectionOptions:{onGetCameraError:o,onGetMicrophoneError:r,onGetAudioOutputError:s}}),b=p.watchPermissions(((e,i)=>{t.permission[e]="granted"===i}));return v.release=h,v.releaseStream=x,t.mediaDeviceDetection=p,t.microphoneList=m.value,t.cameraList=f.value,t.audioOutputList=g.value,d.addEventListener("close",(()=>{b.abort(),h([t.currentCameraStream])})),"function"==typeof i?i(d,t,e):C(d,t,e)}}function O(e){const t=document.createElement("dialog");return t.append.apply(t,e(t)),function(e,t){const i=Array.isArray(t)?t:[t],n="string"==typeof e?document.querySelector(e):e;n&&i.forEach((e=>{n?.classList?.contains?.(e)||n?.classList?.add?.(e)}))}(t,u),t}function D(e,...t){const i="dialog"===e?u:d;var n;n=i,customElements.get(n)||customElements.define(n,class extends HTMLDivElement{constructor(){super()}},{extends:"div"});const o=document.createElement(i),r=o.attachShadow({mode:"open"});return function(e,t=`global-customer-css-${Date.now()}`,i=document){const n=document.createElement("style");n.id=t;const o=document.createTextNode(e);n.appendChild(o),i===document?i.head.appendChild(n):i.insertBefore(n,i.firstChild)}("dialog"===e?l:p,`${c}style`,r),r.append.apply(r,t),{shadowRoot:r,root:o}}function R(e={video:!0,audio:!0},t){const{promise:i,resolve:n}=Promise.withResolvers(),o=O(L(e,h,t)),r=D("dialog",o),a=()=>{let t=!0,i=!0;return e.video&&(i=h.permission.camera&&!!h.currentCameraStream),e.audio&&(t=h.permission.microphone&&!!h.currentMicrophone&&h.microphoneHasVoice),t&&i},c=()=>{const e={...h.currentIds};return Reflect.deleteProperty(e,"__parentKey"),e};return o.addEventListener("close",(()=>{s.stop(),r.root.remove(),f();const e={returnValue:o.returnValue,currentIds:c(),deviceOk:a()};n(e)})),Reflect.set(i,"deviceOk",a),Reflect.set(i,"getCurrentIds",c),Reflect.set(i,"dialog",o),document.body.append(r.root),o.showModal(),i}export{R as displayDialogView,a as useMediaDeviceDetection};