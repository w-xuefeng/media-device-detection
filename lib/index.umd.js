!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).mediaDeviceDetection={})}(this,(function(e){"use strict";function t(e,t,o){const i=document.createElement(e);return t&&Object.entries(t).forEach((([e,t])=>{"arrts"===e&&"object"==typeof t&&null!==t?Object.entries(t).forEach((([e,t])=>{i.setAttribute(e,t)})):"on"===e&&"object"==typeof t&&null!==t?Object.entries(t).forEach((([e,t])=>{i.addEventListener(e,"function"==typeof t?t.bind(i):{...t,handleEvent:t.handleEvent.bind(i)})})):"style"===e?"object"==typeof t&&null!==t?Object.entries(t).forEach((([e,t])=>{Reflect.set(i.style,e,t)})):"string"==typeof t&&Reflect.set(i.style,"cssText",t):"arrts"!==e&&"on"!==e&&"style"!==e&&Reflect.set(i,e,t)})),o&&i.append.apply(i,Array.isArray(o)?o:[o]),i}const o=function(e){const t=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(t)}("registerProcessor('volume-detection-processor',class VolumeDetectionProcessor extends AudioWorkletProcessor{constructor(){super()}process(inputs){const input=inputs[0][0];const buffer=new Float32Array(input);const maxVal=Math.max(...buffer);this.port.postMessage({type:'volumeChange',volume:maxVal*100});return true}});");var i={volumeChangeEventName:`media-device-detection-volume-change-${Date.now()}`,defaultCameraList:[{label:"4K(UHD)",width:3840,height:2160,ratio:"16:9"},{label:"4K(UHD)",width:2160,height:3840,ratio:"9:16"},{label:"2K",width:2560,height:1440,ratio:"16:9"},{label:"2K",width:1440,height:2560,ratio:"9:16"},{label:"1080p(FHD)",width:1920,height:1080,ratio:"16:9"},{label:"1080p(FHD)",width:1080,height:1920,ratio:"9:16"},{label:"UXGA",width:1600,height:1200,ratio:"4:3"},{label:"UXGA",width:1200,height:1600,ratio:"3:4"},{label:"720p(HD)",width:1280,height:720,ratio:"16:9"},{label:"720p(HD)",width:720,height:1280,ratio:"9:16"},{label:"SVGA",width:800,height:600,ratio:"4:3"},{label:"SVGA",width:600,height:800,ratio:"3:4"},{label:"VGA",width:640,height:480,ratio:"4:3"},{label:"360p(nHD)",width:640,height:360,ratio:"16:9"},{label:"CIF",width:352,height:288,ratio:"4:3"},{label:"QVGA",width:320,height:240,ratio:"4:3"},{label:"QCIF",width:176,height:144,ratio:"4:3"},{label:"QQVGA",width:160,height:120,ratio:"4:3"}]},n=class{audioContext=null;audioWorkletNode=null;micStream=null;micStreamSource=null;onGetCameraError=e=>{console.debug("getCameraDeviceList error",e)};onGetMicrophoneError=e=>{console.debug("getMicrophoneDeviceList error",e)};onGetAudioOutputError=e=>{console.debug("getAudioOutputDeviceList error",e)};constructor(e){"function"==typeof e?.onGetCameraError&&(this.onGetCameraError=e.onGetCameraError),"function"==typeof e?.onGetMicrophoneError&&(this.onGetMicrophoneError=e.onGetMicrophoneError),"function"==typeof e?.onGetAudioOutputError&&(this.onGetAudioOutputError=e.onGetAudioOutputError)}async getCameraList(){try{const e=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)),t=async e=>{try{const t=await navigator.mediaDevices.getUserMedia({video:{deviceId:e.deviceId}}),o=t.getTracks().find((e=>"video"===e.kind));if(!o)return null;const i=Object.assign({},{InputDeviceInfo:e},o.getCapabilities());return t.getTracks().forEach((e=>e.stop())),i}catch(e){return this.onGetCameraError(e),null}},o=e.map(t),i=await Promise.allSettled(o),n=i.filter((e=>"fulfilled"===e.status&&e.value)).map((e=>e.value));return n.sort(((e,t)=>(e.width?.max||0)-(t.width?.max||0)))}catch(e){this.onGetCameraError(e)}}getResolution(e){return i.defaultCameraList.filter((t=>t.width<=(e.width?.max||0)&&t.height<=(e.height?.max||0)))}async getMicrophoneList(){try{return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"audioinput"===e.kind))}catch(e){this.onGetMicrophoneError(e)}}async getAudioOutputDeviceList(){try{return(await navigator.mediaDevices.enumerateDevices()).filter((e=>"audiooutput"===e.kind))}catch(e){this.onGetAudioOutputError(e)}}async testMicrophone(e){try{this.audioContext?this.closeCurrentMicrophone():(this.audioContext=new(globalThis.AudioContext||globalThis.webkitAudioContext),await this.audioContext.audioWorklet.addModule(o),this.audioWorkletNode=new AudioWorkletNode(this.audioContext,"volume-detection-processor"),this.audioWorkletNode.port.onmessage=e=>{if("volumeChange"===e.data.type){const t=e.data.volume;globalThis.dispatchEvent(new CustomEvent(i.volumeChangeEventName,{detail:t}))}},this.audioWorkletNode.connect(this.audioContext.destination));const t=await navigator.mediaDevices.getUserMedia({audio:{deviceId:e,echoCancellation:!0}});this.micStream=t,this.micStreamSource=this.audioContext.createMediaStreamSource(this.micStream),this.audioWorkletNode&&this.micStreamSource.connect(this.audioWorkletNode)}catch(e){this.onGetMicrophoneError(e)}}closeCurrentMicrophone(){this.audioWorkletNode&&this.micStreamSource?.disconnect(this.audioWorkletNode),this.micStream?.getAudioTracks().forEach((e=>{e.stop()}))}releaseMicrophone(){this.closeCurrentMicrophone(),this.audioContext&&(this.audioWorkletNode?.disconnect(this.audioContext.destination),this.audioContext=null)}};function r(e){const t={value:[]},o={value:[]},r={value:[]},a=new n(e?.mediaDeviceDetectionOptions),c=function(e,t,o={}){let i,n=0;return(...r)=>{const a=Date.now();n||!1!==o.leading||(n=a);const c=t-(a-n);c<0?(i&&(clearTimeout(i),i=null),n=a,e(...r)):i||!1===o.trailing||(i=window.setTimeout((()=>{n=!1===o.leading?0:(new Date).getTime(),i=null,e(...r)}),c))}}((t=>{e?.onVolumeChange?.(t)}),50);function s(e){c(e)}function u(){a.releaseMicrophone(),globalThis.removeEventListener(i.volumeChangeEventName,s)}function d(e){e?.getTracks().forEach((e=>e.stop()))}return globalThis.addEventListener(i.volumeChangeEventName,s),e?.video&&a.getCameraList().then((o=>{t.value=o||[],e?.onCameraListReady?.(o||[])})),e?.audio&&(a.getMicrophoneList().then((e=>e?.map(((e,t)=>(e.label||Reflect.set(e,"extraLabel","外置麦克风(Built-In) "+(t>0?`${t+1}`:"")),e.deviceId||Reflect.set(e,"extraDeviceId","default"+(t>0?`${t+1}`:"")),e))))).then((t=>{o.value=t||[],e?.onMicrophoneListReady?.(t||[])})),a.getAudioOutputDeviceList().then((e=>e?.map(((e,t)=>(e.label||Reflect.set(e,"extraLabel","外置扬声器(Built-In) "+(t>0?`${t+1}`:"")),e.deviceId||Reflect.set(e,"extraDeviceId","default"+(t>0?`${t+1}`:"")),e))))).then((t=>{r.value=t||[],e?.onAudioOutputListReady?.(t||[])}))),{cameraList:t,microphoneList:o,audioOutputList:r,mediaDeviceDetection:a,release:function(e){u(),e?.forEach((e=>d(e)))},releaseMicrophone:u,releaseStream:d}}const a="media-device-detection-",c=`${a}dialog`,s=`${a}panel`,u=".media-device-detection-dialog {\n  --action-bar-height: 38px;\n  --width: clamp(500px, 80vw, 1000px);\n  --height: clamp(300px, 50vh, 500px);\n\n  display: flex;\n  flex-direction: column;\n  width: var(--width);\n  height: var(--height);\n  border-color: transparent;\n\n  .acton-bar {\n    height: var(--action-bar-height);\n    display: flex;\n    align-items: center;\n    justify-content: flex-end;\n    gap: 12px;\n\n    .cancel-btn {\n      box-sizing: border-box;\n      padding: 5px 20px;\n      font-size: 14px;\n      color: #1e90ff;\n      border-radius: 2px;\n      cursor: pointer;\n      outline: none;\n      border: 1px solid #1e90ff;\n      background-color: #fff;\n    }\n\n    .confirm-btn {\n      box-sizing: border-box;\n      padding: 5px 20px;\n      font-size: 14px;\n      color: #fff;\n      border-radius: 2px;\n      cursor: pointer;\n      outline: none;\n      border: none;\n      background: #1e90ff;\n    }\n  }\n\n  .permission {\n    display: flex;\n    flex-direction: column;\n    .no-permission {\n      margin-top: 4px;\n    }\n  }\n\n  .main {\n    display: flex;\n    justify-content: center;\n    gap: 10%;\n    flex-grow: 1;\n\n    .camera {\n      flex: 1;\n    }\n\n    .label {\n      margin: 0 0 10px 0;\n      color: #999;\n      font-weight: 400;\n    }\n\n    .media-select {\n      width: 100%;\n    }\n    .camera-video {\n      border: 1px solid #eaeaea;\n      margin-top: 20px;\n      width: 100%;\n      border-radius: 4px;\n      min-height: 270px;\n      background-color: #eaeaea;\n    }\n\n    .microphone-sound {\n      flex: 1;\n\n      .microphone-detection {\n        width: 100%;\n        height: 10px;\n        margin-top: 10px;\n        border-radius: 2px;\n        overflow: hidden;\n        background-color: #eaeaea;\n        position: relative;\n\n        .line-gap {\n          height: 100%;\n          width: 2px;\n          background-color: #ffffff;\n          position: absolute;\n          top: 0;\n        }\n\n        .microphone-voice {\n          --volume-width: 0;\n          width: var(--volume-width);\n          height: 100%;\n          background-color: #2980fb;\n        }\n      }\n    }\n  }\n}\n",d=".media-device-detection-panel {\n  --action-bar-height: 60px;\n  --width: clamp(500px, 80vw, 1000px);\n  --height: clamp(300px, 50vh, 500px);\n\n  display: flex;\n  flex-direction: column;\n  width: var(--width);\n  height: var(--height);\n  border-color: transparent;\n}\n",{value:l,onProperty:m}=function(e,t={deep:!1}){let o=[];function i(e,t,o,i,n){e.watchProperties?e.watchProperties?.includes(t)&&e(i,n,o,t):e(o,t,i,n)}const n={get(e,o){const i=Reflect.get(e,o),r=!!t.excludeType&&t.excludeType.some((e=>i instanceof e));return!t?.deep||"object"!=typeof i||null===i||r?i:(console.debug("[[GET Object]]",e,o,i),new Proxy(i,n))},set(e,t,n){const r=Reflect.get(e,t);return r===n||(console.debug("[[SET Object]]",e,t,n),Reflect.set(e,t,n),o.forEach((o=>i(o,t,e,n,r)))),!0},deleteProperty(e,t){const n=Reflect.get(e,t),r=Reflect.deleteProperty(e,t);return o.forEach((o=>i(o,t,e,void 0,n))),r},defineProperty(e,t,n){const r=Reflect.get(e,t),a=Reflect.defineProperty(e,t,n);return o.forEach((o=>i(o,t,e,n?.value||n?.get?.(),r))),a}};return{value:new Proxy(e,n),on:function(e,t=!1){if(!o.includes(e))if(t){const t=(i,n,r,a)=>{e(i,n,r,a),o=o.filter((e=>e!==t))};o.push(t)}else o.push(e)},off:function(e){o=o.filter((t=>t!==e))},clean:function(){o=[]},onProperty:function(e,t,i=!1){const n="number"==typeof e?String(e):e;if(t.watchProperties?t.watchProperties.push(n):t.watchProperties=[n],!o.includes(t)){if(i){const e=(i,n,r,a)=>{t(i,n,r,a),o=o.filter((t=>t!==e))};return e.watchProperties=[n],void o.push(e)}o.push(t)}}}}({currentIds:{camera:"",microphone:"",audioOutput:""},permission:{camera:!0,microphone:!0,audioOutput:!0},currentCamera:null,currentCameraStream:null,currentMicrophone:null,currentAudioOutputDevice:null,cameraVideoRef:null,volumeRef:null,audioRef:null,currentAudioOutputStream:null,microphoneHasVoice:!1,audioPaused:!0,microphoneList:[],cameraList:[],audioOutputList:[],mediaDeviceDetection:null,audioOutputDetectionMusic:"http://music.163.com/song/media/outer/url?id=447925558.mp3"},{deep:!0,excludeType:[MediaStream,HTMLElement,n]}),p={release:()=>{},releaseStream:e=>{}},h=e=>function(){e.currentIds.camera=this.value,e.currentCamera=e.cameraList.find((e=>e.deviceId===this.value)),b(e,e.currentCamera)};function f(e,o){if(!o.video)return null;const i=t("video",{className:"camera-video",autoplay:!0,muted:!0});e.cameraVideoRef=i,b(e,e.cameraList.find((t=>t.deviceId===e.currentIds.camera))||e.cameraList[0]);const n=()=>[t("h3",{className:"label"},"摄像头"),t("select",{className:"media-select",value:e.currentIds.camera,attrs:{placeholder:"请选择一个摄像头",disabled:String(!e.permission.camera)},on:{change:h(e)}},e.cameraList.map((e=>t("option",{value:e.deviceId},e.InputDeviceInfo.label)))),i],r=t("div",{className:"camera"},n());return m("cameraList",(()=>{!function(e,t){Array.from(e.children).forEach((t=>e.removeChild(t)));const o=t();e.append.apply(e,Array.isArray(o)?o:[o])}(r,n)})),r}function v(e,o){if(!o.audio)return null;const i=new Array(10).fill(0).map(((e,o)=>t("div",{className:"line-gap",style:{left:10*o+"%"}}))),n=t("div",{className:"microphone-voice"});e.volumeRef=n;const r=t("div",{className:"microphone-detection"},[...i,n]);return t("div",{className:"microphone-sound"},[r])}function g(e,o,i){const n=t("main",{className:"main"},[f(o,i),v(o,i)].filter((e=>!!e))),r=t("button",{className:"cancel-btn",on:{click:()=>{e.close()}}},"取消"),a=t("button",{className:"confirm-btn",on:{click:()=>{e.close(Object.entries(o.currentIds).map((([e,t])=>`${e}:${t}`)).join("|"))}}},"确定"),c=t("div",{className:"acton-bar"},[r,a]),s=function(e,o){let i=null,n=null,r=null;o.video&&!e.permission.camera&&(i=t("div",{className:"no-permission"},"未开启摄像头权限，请在开启权限后重试")),o.audio&&!e.permission.microphone&&(n=t("div",{className:"no-permission"},"未开启麦克风权限，请在开启权限后重试")),o.audio&&!e.permission.audioOutput&&(r=t("div",{className:"no-permission"},"未开启扬声器权限，请在开启权限后重试"));const a=t("div",{className:"permission"},[i,n,r].filter((e=>!!e)));return m("permission",(e=>{console.log("🚀 ~ onStoreChange permission ~ value:",e)})),a.hasChildNodes()?a:null}(o,i);return[s,n,c].filter((e=>!!e))}async function b(e,t){e?.cameraVideoRef&&t&&(e.currentCameraStream&&e.currentCameraStream.getTracks().forEach((e=>e.stop())),e.currentCameraStream=await navigator.mediaDevices.getUserMedia({audio:!1,video:{deviceId:t.InputDeviceInfo.deviceId,width:t.width,height:t.height}}),e.cameraVideoRef.srcObject=e.currentCameraStream,console.log("🚀 ~ store.currentCameraStream:",e.currentCameraStream))}function y(e,t,o){const i=o=>{e.onVolumeChange?.(o),t.volumeRef&&(!t.microphoneHasVoice&&o.detail>0&&(t.microphoneHasVoice=!0),![-1/0].includes(o.detail)&&o.detail>=0&&function(e,t,o=document.documentElement,i){o||console.log(`[setCssVar ${e}: ${t} error] dom may not exist`,o),(Array.isArray(o)?o:[o]).forEach((o=>{"string"==typeof o?document.querySelector(o)?.style.setProperty(e,t,i):o?.style.setProperty(e,t,i)}))}("--volume-width",`${o.detail<1?1+o.detail:o.detail}%`,t.volumeRef))},n=e=>{console.log("onGetCameraError",e?.message),t.permission.camera=!1},a=e=>{console.log("onGetMicrophoneError",e?.message),t.permission.microphone=!1},c=e=>{console.log("onGetAudioOutputError",e?.message),t.permission.audioOutput=!1},s=e=>{e[0]?(t.permission.camera=!0,t.currentCamera=e[0],t.currentIds.camera=t.currentCamera?.InputDeviceInfo.deviceId,t.cameraList=e,b(t,t.currentCamera)):t.permission.camera=!1},u=e=>{if(!e[0])return t.permission.microphone=!1,void(t.microphoneList=[]);t.permission.microphone=!0,t.currentMicrophone=e[0],t.currentIds.microphone=t.currentMicrophone.extraDeviceId||t.currentMicrophone.deviceId,t.microphoneList=e,function(e,t,o=!1){o||(e.currentMicrophone=e.microphoneList.find((e=>e.deviceId===t))||null),console.log("store.mediaDeviceDetection",e.mediaDeviceDetection),e.mediaDeviceDetection?.testMicrophone(t)}(t,t.currentIds.microphone,!0)},d=e=>{e[0]?(t.permission.audioOutput=!0,t.currentAudioOutputDevice=e[0],t.currentIds.audioOutput=t.currentAudioOutputDevice.extraDeviceId||t.currentAudioOutputDevice.deviceId,t.audioOutputList=e,(async(e,t)=>{e?.audioRef&&t&&(e.currentAudioOutputStream&&e.currentAudioOutputStream.getTracks().forEach((e=>e.stop())),e.audioRef.paused||e.audioRef.pause(),e.currentAudioOutputStream=await navigator.mediaDevices.getUserMedia({video:!1,audio:{deviceId:t}}),e.audioRef.src=e.audioOutputDetectionMusic)})(t,t.currentIds.audioOutput),t.audioRef&&(t.audioRef.onplay=()=>{t.audioPaused=!1},t.audioRef.onpause=()=>{t.audioPaused=!0})):t.permission.audioOutput=!1};return function(l){const{mediaDeviceDetection:m,release:h,microphoneList:f,cameraList:v,audioOutputList:b,releaseStream:y}=r({...e,onVolumeChange:i,onCameraListReady:s,onMicrophoneListReady:u,onAudioOutputListReady:d,mediaDeviceDetectionOptions:{onGetCameraError:n,onGetMicrophoneError:a,onGetAudioOutputError:c}});return p.release=h,p.releaseStream=y,t.mediaDeviceDetection=m,t.microphoneList=f.value,t.cameraList=v.value,t.audioOutputList=b.value,l.addEventListener("close",(()=>{h([t.currentCameraStream])})),"function"==typeof o?o(l,t,e):g(l,t,e)}}function x(e){const t=document.createElement("dialog");return t.append.apply(t,e(t)),function(e,t){const o=Array.isArray(t)?t:[t],i="string"==typeof e?document.querySelector(e):e;i&&o.forEach((e=>{i?.classList?.contains?.(e)||i?.classList?.add?.(e)}))}(t,c),t}function w(e,...t){const o="dialog"===e?c:s;var i;i=o,customElements.get(i)||customElements.define(i,class extends HTMLDivElement{constructor(){super()}},{extends:"div"});const n=document.createElement(o),r=n.attachShadow({mode:"open"});return function(e,t=`global-customer-css-${Date.now()}`,o=document){const i=document.createElement("style");i.id=t;const n=document.createTextNode(e);i.appendChild(n),o===document?o.head.appendChild(i):o.insertBefore(i,o.firstChild)}("dialog"===e?u:d,`${a}style`,r),r.append.apply(r,t),{shadowRoot:r,root:n}}e.displayDialogView=function(e={video:!0,audio:!0},t){const o=x(y(e,l,t)),i=w("dialog",o);return o.addEventListener("close",(()=>{console.log("🚀 ~ dialog.onClose ~ dialog.returnValue:",o.returnValue),i.root.remove()})),Reflect.set(o,"deviceOk",(()=>{let t=!0,o=!0;return e.video&&(o=l.permission.camera&&!!l.currentCameraStream),e.audio&&(t=l.permission.microphone&&!!l.currentMicrophone&&l.microphoneHasVoice),console.log("AudioOk",t,"VideoOk",o),t&&o})),document.body.append(i.root),o.showModal(),o},e.useMediaDeviceDetection=r}));